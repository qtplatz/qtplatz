
QTDIR      = @QTDIR@
DEPLOYQT   = ${QTDIR}/bin/macdeployqt
FRAMEWORKS = ./qtplatz.app/Contents/Frameworks
PLUGINS    = ./qtplatz.app/Contents/PlugIns
TARGET     = qtplatz-@QTPLATZ_VERSION@.dmg
QTPLATZ_SOURCE_DIR = @QTPLATZ_SOURCE_DIR@

default:
	@echo "################################################"
	@echo "DEPLOYQT is: " $(DEPLOYQT)
	@echo "################################################"
	@echo " -- do following procedure -- or make world -- "
	@echo "################################################"
	@echo "make app"
	@echo "make deployqt"
	@echo "make dmg"
	@echo

world:
	make app
	make deployqt
	make dmg

stage:
	make app

# all: qtplatz.app
app:
	tar --exclude "*_debug.*.dylib" --exclude "*_debug.*.a" -C ../bin -c . | tar xvf -
	find @Boost_LIBRARY_DIRS@ -name "libboost_*.dylib" -exec cp -p {} qtplatz.app/Contents/Frameworks/ \;

clean:
	rm -rf qtplatz.app ${TARGET}

translations:
	cp -rp ${QTDIR}/translations ./qtplatz.app/Contents/Resources

deployqt:
	${DEPLOYQT} ./qtplatz.app -verbose=2

dmg: qtplatz.app translations
	hdiutil create -size 250m ${TARGET} -srcfolder ./qtplatz.app

# ---- debug helpers ----------

otool:
	otool -L qtplatz.app/Contents/MacOS/qtplatz
	otool -L qtplatz.app/Contents/Plugins/QtProject/*.dylib
	otool -L qtplatz.app/Contents/Frameworks/*.dylib
	otool -L qtplatz.app/Contents/Plugins/MS-Cheminformatics/*.dylib
	for i in QtCore QtGui QtWidgets QtPrintSupport; do \
		otool -L ${FRAMEWORKS}/$$i.framework/Versions/5/$$i; \
	done
	@echo "-------- ---------"
	otool -L ${PLUGINS}/platforms/libqcocoa.dylib

test:
	DYLD_PRINT_LIBRARIES=1 qtplatz.app/Contents/MacOS/adfile

rpath:
	for i in qtplatz.app/Contents/MacOS/*; do \
		echo $$i; \
		otool -l $$i | grep RPATH -A2; \
	done

add_rpath:
	for i in adfile adimport adurlx eventtool formula_parser; do \
		echo $$i; \
		install_name_tool -add_rpath @executable_path/../Frameworks qtplatz.app/Contents/MacOS/$$i; \
	done
	for i in qtplatz.app/Library/Python/3.7/site-packages/qtplatz/*.so; do \
		echo $$i; \
		install_name_tool -add_rpath @loader_path/../../../../../Contents/Frameworks $$i; \
	done


